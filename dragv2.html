<head>
    <meta pageName="author" content="Lucas Morales, MIT RELATE Group" />
	<script>
		/*! Adapted from: Draggabilly v1.1.0 | http://draggabilly.desandro.com | MIT License */    (function(t){function e(t){return RegExp("(^|\\s+)"+t+"(\\s+|$)")}function n(t,e){var n=i(t,e)?r:o;n(t,e)}var i,o,r;"classList"in document.documentElement?(i=function(t,e){return t.classList.contains(e)},o=function(t,e){t.classList.add(e)},r=function(t,e){t.classList.remove(e)}):(i=function(t,n){return e(n).test(t.className)},o=function(t,e){i(t,e)||(t.className=t.className+" "+e)},r=function(t,n){t.className=t.className.replace(e(n)," ")});var s={hasClass:i,addClass:o,removeClass:r,toggleClass:n,has:i,add:o,remove:r,toggle:n};"function"==typeof define&&define.amd?define("classie/classie",s):t.classie=s})(window),function(){function t(){}function e(t,e){for(var n=t.length;n--;)if(t[n].listener===e)return n;return-1}function n(t){return function(){return this[t].apply(this,arguments)}}var i=t.prototype,o=this,r=o.EventEmitter;i.getListeners=function(t){var e,n,i=this._getEvents();if(t instanceof RegExp){e={};for(n in i)i.hasOwnProperty(n)&&t.test(n)&&(e[n]=i[n])}else e=i[t]||(i[t]=[]);return e},i.flattenListeners=function(t){var e,n=[];for(e=0;t.length>e;e+=1)n.push(t[e].listener);return n},i.getListenersAsObject=function(t){var e,n=this.getListeners(t);return n instanceof Array&&(e={},e[t]=n),e||n},i.addListener=function(t,n){var i,o=this.getListenersAsObject(t),r="object"==typeof n;for(i in o)o.hasOwnProperty(i)&&-1===e(o[i],n)&&o[i].push(r?n:{listener:n,once:!1});return this},i.on=n("addListener"),i.addOnceListener=function(t,e){return this.addListener(t,{listener:e,once:!0})},i.once=n("addOnceListener"),i.defineEvent=function(t){return this.getListeners(t),this},i.defineEvents=function(t){for(var e=0;t.length>e;e+=1)this.defineEvent(t[e]);return this},i.removeListener=function(t,n){var i,o,r=this.getListenersAsObject(t);for(o in r)r.hasOwnProperty(o)&&(i=e(r[o],n),-1!==i&&r[o].splice(i,1));return this},i.off=n("removeListener"),i.addListeners=function(t,e){return this.manipulateListeners(!1,t,e)},i.removeListeners=function(t,e){return this.manipulateListeners(!0,t,e)},i.manipulateListeners=function(t,e,n){var i,o,r=t?this.removeListener:this.addListener,s=t?this.removeListeners:this.addListeners;if("object"!=typeof e||e instanceof RegExp)for(i=n.length;i--;)r.call(this,e,n[i]);else for(i in e)e.hasOwnProperty(i)&&(o=e[i])&&("function"==typeof o?r.call(this,i,o):s.call(this,i,o));return this},i.removeEvent=function(t){var e,n=typeof t,i=this._getEvents();if("string"===n)delete i[t];else if(t instanceof RegExp)for(e in i)i.hasOwnProperty(e)&&t.test(e)&&delete i[e];else delete this._events;return this},i.removeAllListeners=n("removeEvent"),i.emitEvent=function(t,e){var n,i,o,r,s=this.getListenersAsObject(t);for(o in s)if(s.hasOwnProperty(o))for(i=s[o].length;i--;)n=s[o][i],n.once===!0&&this.removeListener(t,n.listener),r=n.listener.apply(this,e||[]),r===this._getOnceReturnValue()&&this.removeListener(t,n.listener);return this},i.trigger=n("emitEvent"),i.emit=function(t){var e=Array.prototype.slice.call(arguments,1);return this.emitEvent(t,e)},i.setOnceReturnValue=function(t){return this._onceReturnValue=t,this},i._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},i._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return o.EventEmitter=r,t},"function"==typeof define&&define.amd?define("eventEmitter/EventEmitter",[],function(){return t}):"object"==typeof module&&module.exports?module.exports=t:this.EventEmitter=t}.call(this),function(t){function e(e){var n=t.event;return n.target=n.target||n.srcElement||e,n}var n=document.documentElement,i=function(){};n.addEventListener?i=function(t,e,n){t.addEventListener(e,n,!1)}:n.attachEvent&&(i=function(t,n,i){t[n+i]=i.handleEvent?function(){var n=e(t);i.handleEvent.call(i,n)}:function(){var n=e(t);i.call(t,n)},t.attachEvent("on"+n,t[n+i])});var o=function(){};n.removeEventListener?o=function(t,e,n){t.removeEventListener(e,n,!1)}:n.detachEvent&&(o=function(t,e,n){t.detachEvent("on"+e,t[e+n]);try{delete t[e+n]}catch(i){t[e+n]=void 0}});var r={bind:i,unbind:o};"function"==typeof define&&define.amd?define("eventie/eventie",r):"object"==typeof exports?module.exports=r:t.eventie=r}(this),function(t){function e(t){if(t){if("string"==typeof i[t])return t;t=t.charAt(0).toUpperCase()+t.slice(1);for(var e,o=0,r=n.length;r>o;o++)if(e=n[o]+t,"string"==typeof i[e])return e}}var n="Webkit Moz ms Ms O".split(" "),i=document.documentElement.style;"function"==typeof define&&define.amd?define("get-style-property/get-style-property",[],function(){return e}):"object"==typeof exports?module.exports=e:t.getStyleProperty=e}(window),function(t){function e(t){var e=parseFloat(t),n=-1===t.indexOf("%")&&!isNaN(e);return n&&e}function n(){for(var t={width:0,height:0,innerWidth:0,innerHeight:0,outerWidth:0,outerHeight:0},e=0,n=s.length;n>e;e++){var i=s[e];t[i]=0}return t}function i(t){function i(t){if("string"==typeof t&&(t=document.querySelector(t)),t&&"object"==typeof t&&t.nodeType){var i=r(t);if("none"===i.display)return n();var o={};o.width=t.offsetWidth,o.height=t.offsetHeight;for(var d=o.isBorderBox=!(!u||!i[u]||"border-box"!==i[u]),p=0,c=s.length;c>p;p++){var f=s[p],l=i[f];l=a(t,l);var g=parseFloat(l);o[f]=isNaN(g)?0:g}var v=o.paddingLeft+o.paddingRight,m=o.paddingTop+o.paddingBottom,y=o.marginLeft+o.marginRight,E=o.marginTop+o.marginBottom,x=o.borderLeftWidth+o.borderRightWidth,b=o.borderTopWidth+o.borderBottomWidth,L=d&&h,P=e(i.width);P!==!1&&(o.width=P+(L?0:v+x));var S=e(i.height);return S!==!1&&(o.height=S+(L?0:m+b)),o.innerWidth=o.width-(v+x),o.innerHeight=o.height-(m+b),o.outerWidth=o.width+y,o.outerHeight=o.height+E,o}}function a(t,e){if(o||-1===e.indexOf("%"))return e;var n=t.style,i=n.left,r=t.runtimeStyle,s=r&&r.left;return s&&(r.left=t.currentStyle.left),n.left=e,e=n.pixelLeft,n.left=i,s&&(r.left=s),e}var h,u=t("boxSizing");return function(){if(u){var t=document.createElement("div");t.style.width="200px",t.style.padding="1px 2px 3px 4px",t.style.borderStyle="solid",t.style.borderWidth="1px 2px 3px 4px",t.style[u]="border-box";var n=document.body||document.documentElement;n.appendChild(t);var i=r(t);h=200===e(i.width),n.removeChild(t)}}(),i}var o=t.getComputedStyle,r=o?function(t){return o(t,null)}:function(t){return t.currentStyle},s=["paddingLeft","paddingRight","paddingTop","paddingBottom","marginLeft","marginRight","marginTop","marginBottom","borderLeftWidth","borderRightWidth","borderTopWidth","borderBottomWidth"];"function"==typeof define&&define.amd?define("get-size/get-size",["get-style-property/get-style-property"],i):"object"==typeof exports?module.exports=i(require("get-style-property")):t.getSize=i(t.getStyleProperty)}(window),function(t){function e(t,e){for(var n in e)t[n]=e[n];return t}function n(){}function i(i,o,s,u,d){function c(t,n){this.element="string"==typeof t?r.querySelector(t):t,this.options=e({},this.options),e(this.options,n),this._create()}function f(){return!1}function l(t,e){t.x=void 0!==e.pageX?e.pageX:e.clientX,t.y=void 0!==e.pageY?e.pageY:e.clientY}function g(t,e,n){return n=n||"round",e?Math[n](t/e)*e:t}var v=u("transform"),m=!!u("perspective");e(c.prototype,o.prototype),c.prototype.options={},c.prototype._create=function(){this.position={},this._getPosition(),this.startPoint={x:0,y:0},this.dragPoint={x:0,y:0},this.startPosition=e({},this.position);var t=a(this.element);"relative"!==t.position&&"absolute"!==t.position&&(this.element.style.position="relative"),this.enable(),this.setHandles()},c.prototype.setHandles=function(){this.handles=this.options.handle?this.element.querySelectorAll(this.options.handle):[this.element];for(var e=0,n=this.handles.length;n>e;e++){var i=this.handles[e];t.navigator.pointerEnabled?(s.bind(i,"pointerdown",this),i.style.touchAction="none"):t.navigator.msPointerEnabled?(s.bind(i,"MSPointerDown",this),i.style.msTouchAction="none"):(s.bind(i,"mousedown",this),s.bind(i,"touchstart",this),E(i))}};var y="attachEvent"in r.documentElement,E=y?function(t){"IMG"===t.nodeName&&(t.ondragstart=f);for(var e=t.querySelectorAll("img"),n=0,i=e.length;i>n;n++){var o=e[n];o.ondragstart=f}}:n;c.prototype._getPosition=function(){var t=a(this.element),e=parseInt(t.left,10),n=parseInt(t.top,10);this.position.x=isNaN(e)?0:e,this.position.y=isNaN(n)?0:n,this._addTransformPosition(t)},c.prototype._addTransformPosition=function(t){if(v){var e=t[v];if(0===e.indexOf("matrix")){var n=e.split(","),i=0===e.indexOf("matrix3d")?12:4,o=parseInt(n[i],10),r=parseInt(n[i+1],10);this.position.x+=o,this.position.y+=r}}},c.prototype.handleEvent=function(t){var e="on"+t.type;this[e]&&this[e](t)},c.prototype.getTouch=function(t){for(var e=0,n=t.length;n>e;e++){var i=t[e];if(i.identifier===this.pointerIdentifier)return i}},c.prototype.onmousedown=function(t){var e=t.button;e&&0!==e&&1!==e||this.dragStart(t,t)},c.prototype.ontouchstart=function(t){this.isDragging||this.dragStart(t,t.changedTouches[0])},c.prototype.onMSPointerDown=c.prototype.onpointerdown=function(t){this.isDragging||this.dragStart(t,t)};var x={mousedown:["mousemove","mouseup"],touchstart:["touchmove","touchend","touchcancel"],pointerdown:["pointermove","pointerup","pointercancel"],MSPointerDown:["MSPointerMove","MSPointerUp","MSPointerCancel"]};c.prototype.dragStart=function(e,n){this.isEnabled&&(e.preventDefault?e.preventDefault():e.returnValue=!1,this.pointerIdentifier=void 0!==n.pointerId?n.pointerId:n.identifier,this._getPosition(),this.measureContainment(),l(this.startPoint,n),this.startPosition.x=this.position.x,this.startPosition.y=this.position.y,this.setLeftTop(),this.dragPoint.x=0,this.dragPoint.y=0,this._bindEvents({events:x[e.type],node:e.preventDefault?t:r}),i.add(this.element,"is-dragging"),this.isDragging=!0,this.emitEvent("dragStart",[this,e,n]),this.animate())},c.prototype._bindEvents=function(t){for(var e=0,n=t.events.length;n>e;e++){var i=t.events[e];s.bind(t.node,i,this)}this._boundEvents=t},c.prototype._unbindEvents=function(){var t=this._boundEvents;if(t&&t.events){for(var e=0,n=t.events.length;n>e;e++){var i=t.events[e];s.unbind(t.node,i,this)}delete this._boundEvents}},c.prototype.measureContainment=function(){var t=this.options.containment;if(t){this.size=d(this.element);var e=this.element.getBoundingClientRect(),n=h(t)?t:"string"==typeof t?r.querySelector(t):this.element.parentNode;this.containerSize=d(n);var i=n.getBoundingClientRect();this.relativeStartPosition={x:e.left-i.left,y:e.top-i.top}}},c.prototype.onmousemove=function(t){this.dragMove(t,t)},c.prototype.onMSPointerMove=c.prototype.onpointermove=function(t){t.pointerId===this.pointerIdentifier&&this.dragMove(t,t)},c.prototype.ontouchmove=function(t){var e=this.getTouch(t.changedTouches);e&&this.dragMove(t,e)},c.prototype.dragMove=function(t,e){l(this.dragPoint,e);var n=this.dragPoint.x-this.startPoint.x,i=this.dragPoint.y-this.startPoint.y,o=this.options.grid,r=o&&o[0],s=o&&o[1];n=g(n,r),i=g(i,s),n=this.containDrag("x",n,r),i=this.containDrag("y",i,s),n="y"===this.options.axis?0:n,i="x"===this.options.axis?0:i,this.position.x=this.startPosition.x+n,this.position.y=this.startPosition.y+i,this.dragPoint.x=n,this.dragPoint.y=i,this.emitEvent("dragMove",[this,t,e])},c.prototype.containDrag=function(t,e,n){if(!this.options.containment)return e;var i="x"===t?"width":"height",o=this.relativeStartPosition[t],r=g(-o,n,"ceil"),s=this.containerSize[i]-o-this.size[i];return s=g(s,n,"floor"),Math.min(s,Math.max(r,e))},c.prototype.onmouseup=function(t){this.dragEnd(t,t)},c.prototype.onMSPointerUp=c.prototype.onpointerup=function(t){t.pointerId===this.pointerIdentifier&&this.dragEnd(t,t)},c.prototype.ontouchend=function(t){var e=this.getTouch(t.changedTouches);e&&this.dragEnd(t,e)},c.prototype.dragEnd=function(t,e){this.isDragging=!1,delete this.pointerIdentifier,v&&(this.element.style[v]="",this.setLeftTop()),this._unbindEvents(),i.remove(this.element,"is-dragging"),this.emitEvent("dragEnd",[this,t,e])},c.prototype.onMSPointerCancel=c.prototype.onpointercancel=function(t){t.pointerId===this.pointerIdentifier&&this.dragEnd(t,t)},c.prototype.ontouchcancel=function(t){var e=this.getTouch(t.changedTouches);this.dragEnd(t,e)},c.prototype.animate=function(){if(this.isDragging){this.positionDrag();var t=this;p(function(){t.animate()})}};var b=m?function(t,e){return"translate3d( "+t+"px, "+e+"px, 0)"}:function(t,e){return"translate( "+t+"px, "+e+"px)"};return c.prototype.setLeftTop=function(){this.element.style.left=this.position.x+"px",this.element.style.top=this.position.y+"px"},c.prototype.positionDrag=v?function(){this.element.style[v]=b(this.dragPoint.x,this.dragPoint.y)}:c.prototype.setLeftTop,c.prototype.enable=function(){this.isEnabled=!0},c.prototype.disable=function(){this.isEnabled=!1,this.isDragging&&this.dragEnd()},c}for(var o,r=t.document,s=r.defaultView,a=s&&s.getComputedStyle?function(t){return s.getComputedStyle(t,null)}:function(t){return t.currentStyle},h="object"==typeof HTMLElement?function(t){return t instanceof HTMLElement}:function(t){return t&&"object"==typeof t&&1===t.nodeType&&"string"==typeof t.nodeName},u=0,d="webkit moz ms o".split(" "),p=t.requestAnimationFrame,c=t.cancelAnimationFrame,f=0;d.length>f&&(!p||!c);f++)o=d[f],p=p||t[o+"RequestAnimationFrame"],c=c||t[o+"CancelAnimationFrame"]||t[o+"CancelRequestAnimationFrame"];p&&c||(p=function(e){var n=(new Date).getTime(),i=Math.max(0,16-(n-u)),o=t.setTimeout(function(){e(n+i)},i);return u=n+i,o},c=function(e){t.clearTimeout(e)}),"function"==typeof define&&define.amd?define(["classie/classie","eventEmitter/EventEmitter","eventie/eventie","get-style-property/get-style-property","get-size/get-size"],i):t.Draggable=i(t.classie,t.EventEmitter,t.eventie,t.getStyleProperty,t.getSize)}(window);
		/*! JSChannel | (c) 2010 Lloyd Hilaiel; Mozilla | Mozilla Public License */    var Channel=function(){"use strict";function e(e,t,n,r){function s(t){for(var n=0;n<t.length;n++)if(t[n].win===e)return true;return false}var o=false;if(t==="*"){for(var u in i){if(!i.hasOwnProperty(u))continue;if(u==="*")continue;if(typeof i[u][n]==="object"){o=s(i[u][n]);if(o)break}}}else{if(i["*"]&&i["*"][n]){o=s(i["*"][n])}if(!o&&i[t]&&i[t][n]){o=s(i[t][n])}}if(o)throw"A channel is already bound to the same window which overlaps with origin '"+t+"' and has scope '"+n+"'";if(typeof i[t]!="object")i[t]={};if(typeof i[t][n]!="object")i[t][n]=[];i[t][n].push({win:e,handler:r})}function t(e,t,n){var r=i[t][n];for(var s=0;s<r.length;s++){if(r[s].win===e){r.splice(s,1)}}if(i[t][n].length===0){delete i[t][n]}}function n(e){if(Array.isArray)return Array.isArray(e);else{return e.constructor.toString().indexOf("Array")!=-1}}var r=Math.floor(Math.random()*1000001);var i={};var s={};var o=function(e){try{var t=JSON.parse(e.data);if(typeof t!=="object"||t===null)throw"malformed"}catch(e){return}var n=e.source;var r=e.origin;var o,u,a;if(typeof t.method==="string"){var f=t.method.split("::");if(f.length==2){o=f[0];a=f[1]}else{a=t.method}}if(typeof t.id!=="undefined")u=t.id;if(typeof a==="string"){var l=false;if(i[r]&&i[r][o]){for(var c=0;c<i[r][o].length;c++){if(i[r][o][c].win===n){i[r][o][c].handler(r,a,t);l=true;break}}}if(!l&&i["*"]&&i["*"][o]){for(var c=0;c<i["*"][o].length;c++){if(i["*"][o][c].win===n){i["*"][o][c].handler(r,a,t);break}}}}else if(typeof u!="undefined"){if(s[u])s[u](r,a,t)}};if(window.addEventListener)window.addEventListener("message",o,false);else if(window.attachEvent)window.attachEvent("onmessage",o);return{build:function(i){var o=function(e){if(i.debugOutput&&window.console&&window.console.log){try{if(typeof e!=="string")e=JSON.stringify(e)}catch(t){}console.log("["+f+"] "+e)}};if(!window.postMessage)throw"jschannel cannot run this browser, no postMessage";if(!window.JSON||!window.JSON.stringify||!window.JSON.parse){throw"jschannel cannot run this browser, no JSON parsing/serialization"}if(typeof i!="object")throw"Channel build invoked without a proper object argument";if(!i.window||!i.window.postMessage)throw"Channel.build() called without a valid window argument";if(window===i.window)throw"target window is same as present window -- not allowed";var u=false;if(typeof i.origin==="string"){var a;if(i.origin==="*")u=true;else if(null!==(a=i.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9_\.])+(?::\d+)?/))){i.origin=a[0].toLowerCase();u=true}}if(!u)throw"Channel.build() called with an invalid origin";if(typeof i.scope!=="undefined"){if(typeof i.scope!=="string")throw"scope, when specified, must be a string";if(i.scope.split("::").length>1)throw"scope may not contain double colons: '::'"}var f=function(){var e="";var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(var n=0;n<5;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}();var l={};var c={};var h={};var p=false;var d=[];var v=function(e,t,n){var r=false;var i=false;return{origin:t,invoke:function(t,r){if(!h[e])throw"attempting to invoke a callback of a nonexistent transaction: "+e;var i=false;for(var s=0;s<n.length;s++)if(t===n[s]){i=true;break}if(!i)throw"request supports no such callback '"+t+"'";b({id:e,callback:t,params:r})},error:function(t,n){i=true;if(!h[e])throw"error called for nonexistent message: "+e;delete h[e];b({id:e,error:t,message:n})},complete:function(t){i=true;if(!h[e])throw"complete called for nonexistent message: "+e;delete h[e];b({id:e,result:t})},delayReturn:function(e){if(typeof e==="boolean"){r=e===true}return r},completed:function(){return i}}};var m=function(e,t,n){return window.setTimeout(function(){if(c[e]){var r="timeout ("+t+"ms) exceeded on method '"+n+"'";c[e].error("timeout_error",r);delete c[e];delete s[e]}},t)};var g=function(e,t,r){if(typeof i.gotMessageObserver==="function"){try{i.gotMessageObserver(e,r)}catch(u){o("gotMessageObserver() raised an exception: "+u.toString())}}if(r.id&&t){if(l[t]){var a=v(r.id,e,r.callbacks?r.callbacks:[]);h[r.id]={};try{if(r.callbacks&&n(r.callbacks)&&r.callbacks.length>0){for(var f=0;f<r.callbacks.length;f++){var p=r.callbacks[f];var d=r.params;var m=p.split("/");for(var g=0;g<m.length-1;g++){var y=m[g];if(typeof d[y]!=="object")d[y]={};d=d[y]}d[m[m.length-1]]=function(){var e=p;return function(t){return a.invoke(e,t)}}()}}var b=l[t](a,r.params);if(!a.delayReturn()&&!a.completed())a.complete(b)}catch(u){var w="runtime_error";var E=null;if(typeof u==="string"){E=u}else if(typeof u==="object"){if(u&&n(u)&&u.length==2){w=u[0];E=u[1]}else if(typeof u.error==="string"){w=u.error;if(!u.message)E="";else if(typeof u.message==="string")E=u.message;else u=u.message}}if(E===null){try{E=JSON.stringify(u);if(typeof E=="undefined")E=u.toString()}catch(S){E=u.toString()}}a.error(w,E)}}}else if(r.id&&r.callback){if(!c[r.id]||!c[r.id].callbacks||!c[r.id].callbacks[r.callback]){o("ignoring invalid callback, id:"+r.id+" ("+r.callback+")")}else{c[r.id].callbacks[r.callback](r.params)}}else if(r.id){if(!c[r.id]){o("ignoring invalid response: "+r.id)}else{if(r.error){c[r.id].error(r.error,r.message)}else{if(r.result!==undefined)c[r.id].success(r.result);else c[r.id].success()}delete c[r.id];delete s[r.id]}}else if(t){if(l[t]){l[t]({origin:e},r.params)}}};e(i.window,i.origin,typeof i.scope==="string"?i.scope:"",g);var y=function(e){if(typeof i.scope==="string"&&i.scope.length)e=[i.scope,e].join("::");return e};var b=function(e,t){if(!e)throw"postMessage called with null message";var n=p?"post  ":"queue ";o(n+" message: "+JSON.stringify(e));if(!t&&!p){d.push(e)}else{if(typeof i.postMessageObserver==="function"){try{i.postMessageObserver(i.origin,e)}catch(r){o("postMessageObserver() raised an exception: "+r.toString())}}i.window.postMessage(JSON.stringify(e),i.origin)}};var w=function(e,t){o("ready msg received");if(p)throw"received ready message while in ready state.  help!";if(t==="ping"){f+="-R"}else{f+="-L"}E.unbind("__ready");p=true;o("ready msg accepted.");if(t==="ping"){E.notify({method:"__ready",params:"pong"})}while(d.length){b(d.pop())}if(typeof i.onReady==="function")i.onReady(E)};var E={unbind:function(e){if(l[e]){if(!delete l[e])throw"can't delete method: "+e;return true}return false},bind:function(e,t){if(!e||typeof e!=="string")throw"'method' argument to bind must be string";if(!t||typeof t!=="function")throw"callback missing from bind params";if(l[e])throw"method '"+e+"' is already bound!";l[e]=t;return this},call:function(e){if(!e)throw"missing arguments to call function";if(!e.method||typeof e.method!=="string")throw"'method' argument to call must be string";if(!e.success||typeof e.success!=="function")throw"'success' callback missing from call";var t={};var n=[];var i=[];var o=function(e,r){if(i.indexOf(r)>=0){throw"params cannot be a recursive data structure"}i.push(r);if(typeof r==="object"){for(var s in r){if(!r.hasOwnProperty(s))continue;var u=e+(e.length?"/":"")+s;if(typeof r[s]==="function"){t[u]=r[s];n.push(u);delete r[s]}else if(typeof r[s]==="object"){o(u,r[s])}}}};o("",e.params);var u={id:r,method:y(e.method),params:e.params};if(n.length)u.callbacks=n;if(e.timeout)m(r,e.timeout,y(e.method));c[r]={callbacks:t,error:e.error,success:e.success};s[r]=g;r++;b(u)},notify:function(e){if(!e)throw"missing arguments to notify function";if(!e.method||typeof e.method!=="string")throw"'method' argument to notify must be string";b({method:y(e.method),params:e.params})},destroy:function(){t(i.window,i.origin,typeof i.scope==="string"?i.scope:"");if(window.removeEventListener)window.removeEventListener("message",g,false);else if(window.detachEvent)window.detachEvent("onmessage",g);p=false;l={};h={};c={};i.origin=null;d=[];o("channel destroyed");f=""}};E.bind("__ready",w);setTimeout(function(){b({method:y("__ready"),params:"ping"},true)},0);return E}}}();
		var Modal=function(){var c={},e={},b=document.createElement("div"),a=document.createElement("div"),f=document.createElement("div"),d=document.createElement("div"),g=document.createElement("div");c.open=function(l){e.width=l.width||"auto";e.height=l.height||"auto";d.innerHTML=l.content||"";a.style.width=e.width;a.style.height=e.height;b.style.display="block";a.style.display="block";document.onkeypress=function(a){27===a.keyCode&&!0!==e.lock&&c.close()};g.onclick=c.close;b.onclick=c.close;window.addEventListener?window.addEventListener("resize",void 0,!1):window.attachEvent&&window.attachEvent("onresize",void 0);f.onmousedown=function(){return  !1};c.center({})};c.close=function(){d.innerHTML="",b.style.display="none",a.style.display="none",a.style.display="none",f.style.cursor="default";g.setAttribute("style","");window.removeEventListener?window.removeEventListener("resize",void 0,!1):window.detachEvent&&window.detachEvent("onresize",void 0)};c.center=function(c){var f=Math.max(a.clientWidth,a.offsetWidth),g=Math.max(a.clientHeight,a.offsetHeight),d=0,m=0,h=0,k=0;"number"===typeof window.innerWidth?(d=window.innerWidth,m=window.innerHeight):document.documentElement&&document.documentElement.clientWidth&&(d=document.documentElement.clientWidth,m=document.documentElement.clientHeight);"number"===typeof window.pageYOffset?(k=window.pageYOffset,h=window.pageXOffset):document.body.scrollLeft?(k=document.body.scrollTop,h=document.body.scrollLeft):document.documentElement&&document.documentElement.scrollLeft&&(k=document.documentElement.scrollTop,h=document.documentElement.scrollLeft);a.style.top=k+m/2-g/2+"px",a.style.left=h+d/2-f/2+"px",b.style.height="100%",b.style.width="100%";};b.setAttribute("id","modal-overlay");a.setAttribute("id","modal-container");d.setAttribute("id","modal-content");g.setAttribute("id","modal-close");f.appendChild(g);a.appendChild(f);a.appendChild(d);b.style.display="none";a.style.display="none";window.addEventListener?window.addEventListener("load",function(){document.body.appendChild(b);document.body.appendChild(a)},!1):window.attachEvent&&window.attachEvent("onload",function(){document.body.appendChild(b);document.body.appendChild(a)});return  c}();
		Element.prototype.css=function(p){for(var k in p){this.style[k]=p[k]}};
		Element.prototype.inParent=function(){var b=this.getBoundingClientRect(),p=this.parentNode.getBoundingClientRect(),o={};o.width=b.width,o.height=b.height,o.top=b.top-p.top,o.left=b.left-p.left;return o};
    </script>
    <style>
		p {
			font-size: 1.3em; 
			line-height: 1.5em;
			padding: 0; 
			font-family: 'helvetica neue', helvetica, arial, sans-serif; 
			font-weight: 300; 
		}
		#modal-overlay {
			background: #fff;
			filter: alpha(opacity=60);
			height: 100%;
			left: 0;
			-moz-opacity: 0.6;
			-webkit-opacity: 0.6;
			-ms-filter: alpha(opacity=60);
			opacity: 0.6;
			position: absolute;
			top: 0;
			width: 100%;
			z-index: 998;
		}
		#modal-container {
			background: #fff;
			border: 1px solid #ababab;
			box-shadow: 0px 4px 16px rgba(0, 0, 0, 0.2);
			height: auto;
			padding: 10px;
			position: absolute;
			z-index: 998;
		}
		#modal-header {
			height: 20px;
			overflow: hidden;
			clear: both;
		}
		#modal-close {
			float: right;
			cursor: pointer;
			display: block;
			opacity: 0.6;
			-moz-opacity: 0.6;
			-webkit-opacity: 0.6;
			filter: alpha(opacity=60);
			-ms-filter: alpha(opacity=60);
			width: 0;
			height: 0;
			border-top: 20px solid red;
			border-left: 20px solid transparent;
		}
		#modal-close:hover {
			opacity: 1.0;
			-moz-opacity: 1.0;
			-webkit-opacity: 1.0;
			filter: alpha(opacity=100);
			-ms-filter: alpha(opacity=100);
		}
		#modal-content {
			display: block;
			padding: 0 20px 10px 20px;
			z-index: 999;
		}
        button {
			border: 1px solid rgb(53, 126, 189);
			background-color: rgb(66, 139, 202);
			border-bottom-left-radius: 4px;
			border-bottom-right-radius: 4px;
			border-top-left-radius: 4px;
			border-top-right-radius: 4px;
			box-sizing: border-box;
			color: white;
			cursor: pointer;
			display: inline-block;
			font-size: 18px;
			line-height: 20px;
			margin:5px 0;
			overflow: visible;
			padding:10px 16px;
			white-space: nowrap;
			text-decoration:none;
        }
        button:hover {
			border: 1px solid rgb(40, 94, 142);
			background-color: rgb(48, 113, 169);
        }
        button:active {
			-webkit-box-shadow: rgba(0, 0, 0, 0.121569) 0px 3px 5px 0px inset;
			border: 1px solid rgb(40, 94, 142);
			background-color: rgb(48, 113, 169);
        }
        .text_box {
            overflow: auto;
            display: none;
            background-color: rgb(250, 248, 239);
            margin-bottom: -16px;
            font-size: .5em;
            color: rgb(100, 100, 100);
            font-family: 'Open Sans', Verdana, Geneva, sans-serif, sans-serif;
        }
        .text_box_contents {
            margin-left: 20px;
            margin-right: 20px;
            padding-top: 5px;
            padding-bottom: 5px;
        }
		#helpButton, #resetButton {
			margin:10px 10px 0 0;
			cursor:pointer;
		}
    </style>
</head>
<body>
<script>
var JSInput = (function () {
	
    this.inp = {},this.reusables={};
	var c=this,channel,x;

	this.state=function(){console.log(getState());}

    function $_GET(sVar) {
        return decodeURI(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + encodeURI(sVar).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
    }

	// Recreate reusable draggable if pulling from start
	function drag_start(e) {
		var d=JSON.parse(e.getAttribute('d')),
			q=document.querySelector('.drop'),
			draggable,n;
		if(d.reusable&&isNearStart(e)){
			var n=e.cloneNode(true),r;
			n.css({
				'position':'absolute',
            	'left':d.pos.x-d.size.width/2+'px',
				'top':d.pos.y-d.size.height/2+'px'
			});
			q.appendChild(n);
			r=new Draggable(n,{containment:'.drop'});
			r.on('dragStart',function(){drag_start(this.handles[0])});
			r.on('dragEnd',function(){drag_update(this.handles[0])});
			d.html&&window.MathJax&&MathJax.Hub.Queue(["Typeset",MathJax.Hub,q.children[q.children.length-1]]);
		}
		return!1;
	}

	// Updates a draggable
    function drag_update(e) {
        var d=JSON.parse(e.getAttribute('d')),
			b=e.inParent(),
			t=isNearTarget(e);
		
		// Reset draggable to start location and remove if reusable
        if(isNearStart(e)){
			e.css({
       			'left':d.pos.x-d.size.width/2+'px',	
				'top':d.pos.y-d.size.height/2+'px'
       		});
			d.reusable&&e.parentElement.removeChild(e);
		} else
		
		// Snap to nearby snappable target, if applicable
		if (t){
			if (!isOccupied(t,e)) {
				e.css({
					'left':t[0]-d.size.width/2+'px',
					'top':t[1]-d.size.height/2+'px'
				});
			}
		}
    }

	// Resets all contents
    function reset(s) {
        var d,b,i,j,e,n,draggable,
			frag=document.createDocumentFragment(),
			p=document.querySelector('.drop');
		if(!s) s={};
		
		// Add each draggable to a fragment and store location for returned state
        for (i = 0; i < c.inp.draggables.length; i++) {
            d = c.inp.draggables[i];
			
			// If there's no state for a draggable, revert to initial position
			if(!s[d.id]) {
				s[d.id]=[d.pos.x,d.pos.y];
				if(d.reusable) s[d.id]=[];
			}
			
			// Create an element for the draggable, place in fragment
			e=document.createElement("div");
			e.setAttribute('name',d.id);
			e.className="draggable";
			e.setAttribute('d',JSON.stringify(d));
			e.css({
				'position':'absolute',
				'width':String(d.size.width)+'px',
				'height':String(d.size.height)+'px',
				'left':(d.reusable ? d.pos.x-d.size.width/2+'px' : s[d.id][0]-d.size.width/2+'px'),
				'top':(d.reusable ? d.pos.y-d.size.height/2+'px' : s[d.id][1]-d.size.height/2+'px'),
			});
			if(d.html){
				e.innerHTML=d.html;
			} 
			else {
				e.css({
					'backgroundImage':'url('+d.url+')',
					'backgroundSize':String(d.size.width)+'px '+String(d.size.height)+'px'
				});
			}
			frag.appendChild(e);
			
			if(!d.reusable)continue;
			
			// Create reusable draggables' elements for each in state
			else {
				for(j=0;j<s[d.id].length;j++) {
					n=e.cloneNode(true);
					n.css({
						'position':'absolute',
	        	    	'left':s[d.id][j][0]-d.size.width/2+'px',
						'top':s[d.id][j][1]-d.size.height/2+'px'
					});
					frag.appendChild(n);
				}
			}
        }
		
		// Update DOM
		p.innerHTML='';
        p.appendChild(frag);
		
		// Make draggables actually draggable
        for (i=0,b=document.getElementsByClassName('draggable');i<b.length;i++) {
            draggable=new Draggable(b[i],{containment:'.drop'});
			draggable.on('dragStart',function(){drag_start(this.handles[0])});
			draggable.on('dragEnd',function(){drag_update(this.handles[0])});
		}
		
        return!0;
    }

	// Initializes everything except draggables
    function init(input) {
        c.inp = input;
		var dropE = document.createElement("div"),
			resetE = document.createElement("button"),
			helpE = document.createElement("button"),
			textE = document.createElement("div"),
			textContentE = document.createElement("div"),
			styleE = document.createElement("style"),
			frag = document.createDocumentFragment(),
        	static_style = 'cursor:'+((typeof c.inp.cursor == 'undefined') ? 'move' : c.inp.cursor),
			hover_style = (typeof (c.inp.hoverZoom) !== 'undefined' && c.inp.hoverZoom) ? '-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1);' : '',
			i;
		
		// Add drop image div
		dropE.className="drop",
		dropE.css({
			'position':'relative',
			'backgroundImage':'url('+c.inp.drop_image+')',
			'backgroundSize':c.inp.size.width+'px '+c.inp.size.height+'px',
			'width':c.inp.size.width+'px',
			'height':c.inp.size.height + 'px'
		});
		frag.appendChild(dropE);
		
		// Add help and reset buttons
		resetE.id="resetButton",
		resetE.innerHTML="Reset",
		helpE.id="helpButton",
		helpE.innerHTML="Help";
		frag.appendChild(resetE);
		frag.appendChild(helpE);
		
		// Set default help text
		c.help = c.inp.help || ((typeof (c.inp.hoverZoom) !== 'undefined' && c.inp.hoverZoom) 
			? 'Items that are draggable will expand when your mouse hovers over them.<br>' 
			: '')+
			'Move draggable items to their correct targets.<br>'+
			'If no correct target exists for an item, move the item back to its original location and it will snap into place. Alternatively, you can use the "Reset" button to reset all draggables.<br>'+
			'Click out of this box or on the red triangle to dismiss.';
		
		// Iterate over specified CSS if applicable
        if (typeof (c.inp.css) !== 'undefined')
            for (i = 0; i < c.inp.css.length; i++)
                static_style = static_style + c.inp.css[i][0] + ':' + c.inp.css[i][1] + ';';
        if (typeof (c.inp.hover) !== 'undefined')
            for (i = 0; i < c.inp.hover.length; i++)
                hover_style = hover_style + c.inp.hover[i][0] + ':' + c.inp.hover[i][1] + ';';

		// Push new styles to fragment
		styleE.appendChild(document.createTextNode('.draggable{outline: 2px solid transparent;' + static_style + '}.draggable:hover{' + hover_style + '}'));
		frag.appendChild(styleE);
		
		// Update DOM
		document.body.appendChild(frag);
        reset();
    }
	
	// Return target array [x,y] if element near a target
	function isNearTarget(e) {
        var b=e.inParent(),t,i,o={},q=document.getElementsByClassName('draggable');
		
		if (!c.inp.targets||c.inp.targets.length==0)return!1;
		
		for (i=0;i<c.inp.targets.length;i++) {
        	t=c.inp.targets[i];
			if (Math.abs(b.left + b.width / 2 - t[0]) < b.width && Math.abs(b.top + b.height / 2 - t[1]) < b.height) {
				o[(b.left + b.width / 2 - t[0])*(b.left + b.width / 2 - t[0])+(b.top + b.height / 2 - t[1])*(b.top + b.height / 2 - t[1])]=t
			}
		}
		if(o=={})return!1;
		return o[Math.min.apply(null,Object.keys(o))];
	}
	
	// Return boolean if element near its start
    function isNearStart(e) {
        var b=e.inParent(),d=JSON.parse(e.getAttribute('d'));
        return (Math.abs(b.left + b.width / 2 - d.pos.x) < b.width/2 && Math.abs(b.top + b.height / 2 - d.pos.y) < b.height/2);
    }

	// Return boolean if requested point (target) is occupied (by isNear standards used above)
	function isOccupied(t,e) {
		var i=0,dE,b,
			q=document.getElementsByClassName('draggable');
		for(;i<q.length;i++) {
			dE=q[i];
			if(dE==e){continue}
			b=dE.inParent();
			if(Math.abs(b.left + b.width / 2 - t[0]) < b.width/2 && Math.abs(b.top + b.height / 2 - t[1]) < b.height/2){
				return true;
			}
		}
		return false;
	}
	
	// Get JSON, initialize everything
	x = typeof XMLHttpRequest !== 'undefined' ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
	x.onload = function(){
		var q=JSON.parse(this.responseText);
		if(q.mathjax){
			var mathjax=document.createElement('script');
			mathjax.src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
			document.getElementsByTagName('head')[0].appendChild(mathjax);
		}
		init(q);
   		document.getElementById('resetButton').onclick=reset;
   		document.getElementById('helpButton').onclick=function () {
            Modal.open({content: '<p>'+(c.inp.help||c.help)+'</p>'});
   		};
	};
	x.open("get", $_GET('js')+".json", false);
	x.send();

	// For jsinput grading, bind functions to channel
    if (window.parent !== window) {
        channel = Channel.build({
            window: window.parent,
            origin: "*",
            scope: "JSInput"
        });
        channel.bind("getGrade", getGrade);
        channel.bind("getState", getState);
        channel.bind("setState", setState);
    }

    function getState() {
		// Iterate over draggables return positions
		var i,j,d,dE,dEs,b,p,s={},
			q=document.getElementsByClassName('draggable');
		for (i=0;i<q.length;i++) {
			dE = q[i],
			d=JSON.parse(dE.getAttribute('d')),
			b=dE.inParent(),
			p=[b.left+b.width/2, b.top+b.height/2];
			if(!d.reusable&&!(Math.abs(p[0]-d.pos.x)<5&&Math.abs(p[1]-d.pos.y)<5)) {s[d.id]=p;continue}
			if(!(Math.abs(p[0]-d.pos.x)<5&&Math.abs(p[1]-d.pos.y)<5)){
				if(!s[d.id]) s[d.id]=[];
				s[d.id][s[d.id].length]=p;
			}
		}
        return JSON.stringify(s)
    }

    function getGrade() {
        return JSON.stringify(c.inp)
    }

    function setState() {
        s = JSON.parse(arguments.length === 1 ? arguments[0] : arguments[1]);
		reset(s)
    }
	
    return {
        getState: getState,
        setState: setState,
        getGrade: getGrade
    };
}());
</script>
</body>