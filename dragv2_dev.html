<head>
    <meta pageName="author" content="Lucas Morales, RELATE MIT" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/jquery-ui.min.js"></script>
    <script>
		//Mozilla's JSChannel
        var Channel = function () {
            "use strict";

            function n(e, n, r, i) {
                function s(t) {
                    for (var n = 0; n < t.length; n++)
                        if (t[n].win === e) return true;
                    return false
                }
                var o = false;
                if (n === "*") {
                    for (var u in t) {
                        if (!t.hasOwnProperty(u)) continue;
                        if (u === "*") continue;
                        if (typeof t[u][r] === "object") {
                            o = s(t[u][r]);
                            if (o) break
                        }
                    }
                } else {
                    if (t["*"] && t["*"][r]) {
                        o = s(t["*"][r])
                    }
                    if (!o && t[n] && t[n][r]) {
                        o = s(t[n][r])
                    }
                } if (o) throw "A channel is already bound to the same window which overlaps with origin '" + n + "' and has scope '" + r + "'";
                if (typeof t[n] != "object") t[n] = {};
                if (typeof t[n][r] != "object") t[n][r] = [];
                t[n][r].push({
                    win: e,
                    handler: i
                })
            }

            function r(e, n, r) {
                var i = t[n][r];
                for (var s = 0; s < i.length; s++) {
                    if (i[s].win === e) {
                        i.splice(s, 1)
                    }
                }
                if (t[n][r].length === 0) {
                    delete t[n][r]
                }
            }

            function i(e) {
                if (Array.isArray) return Array.isArray(e);
                else {
                    return e.constructor.toString().indexOf("Array") != -1
                }
            }
            var e = Math.floor(Math.random() * 1000001);
            var t = {};
            var s = {};
            var o = function (e) {
                try {
                    var n = JSON.parse(e.data);
                    if (typeof n !== "object" || n === null) throw "malformed"
                } catch (e) {
                    return
                }
                var r = e.source;
                var i = e.origin;
                var o, u, a;
                if (typeof n.method === "string") {
                    var f = n.method.split("::");
                    if (f.length == 2) {
                        o = f[0];
                        a = f[1]
                    } else {
                        a = n.method
                    }
                }
                if (typeof n.id !== "undefined") u = n.id;
                if (typeof a === "string") {
                    var l = false;
                    if (t[i] && t[i][o]) {
                        for (var c = 0; c < t[i][o].length; c++) {
                            if (t[i][o][c].win === r) {
                                t[i][o][c].handler(i, a, n);
                                l = true;
                                break
                            }
                        }
                    }
                    if (!l && t["*"] && t["*"][o]) {
                        for (var c = 0; c < t["*"][o].length; c++) {
                            if (t["*"][o][c].win === r) {
                                t["*"][o][c].handler(i, a, n);
                                break
                            }
                        }
                    }
                } else if (typeof u != "undefined") {
                    if (s[u]) s[u](i, a, n)
                }
            };
            if (window.addEventListener) window.addEventListener("message", o, false);
            else if (window.attachEvent) window.attachEvent("onmessage", o);
            return {
                build: function (t) {
                    var o = function (e) {
                        if (t.debugOutput && window.console && window.console.log) {
                            try {
                                if (typeof e !== "string") e = JSON.stringify(e)
                            } catch (n) {}
                            console.log("[" + f + "] " + e)
                        }
                    };
                    if (!window.postMessage) throw "jschannel cannot run this browser, no postMessage";
                    if (!window.JSON || !window.JSON.stringify || !window.JSON.parse) {
                        throw "jschannel cannot run this browser, no JSON parsing/serialization"
                    }
                    if (typeof t != "object") throw "Channel build invoked without a proper object argument";
                    if (!t.window || !t.window.postMessage) throw "Channel.build() called without a valid window argument";
                    if (window === t.window) throw "target window is same as present window -- not allowed";
                    var u = false;
                    if (typeof t.origin === "string") {
                        var a;
                        if (t.origin === "*") u = true;
                        else if (null !== (a = t.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9_\.])+(?::\d+)?/))) {
                            t.origin = a[0].toLowerCase();
                            u = true
                        }
                    }
                    if (!u) throw "Channel.build() called with an invalid origin";
                    if (typeof t.scope !== "undefined") {
                        if (typeof t.scope !== "string") throw "scope, when specified, must be a string";
                        if (t.scope.split("::").length > 1) throw "scope may not contain double colons: '::'"
                    }
                    var f = function () {
                        var e = "";
                        var t = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                        for (var n = 0; n < 5; n++) e += t.charAt(Math.floor(Math.random() * t.length));
                        return e
                    }();
                    var l = {};
                    var c = {};
                    var h = {};
                    var p = false;
                    var d = [];
                    var v = function (e, t, n) {
                        var r = false;
                        var i = false;
                        return {
                            origin: t,
                            invoke: function (t, r) {
                                if (!h[e]) throw "attempting to invoke a callback of a nonexistent transaction: " + e;
                                var i = false;
                                for (var s = 0; s < n.length; s++)
                                    if (t === n[s]) {
                                        i = true;
                                        break
                                    }
                                if (!i) throw "request supports no such callback '" + t + "'";
                                b({
                                    id: e,
                                    callback: t,
                                    params: r
                                })
                            },
                            error: function (t, n) {
                                i = true;
                                if (!h[e]) throw "error called for nonexistent message: " + e;
                                delete h[e];
                                b({
                                    id: e,
                                    error: t,
                                    message: n
                                })
                            },
                            complete: function (t) {
                                i = true;
                                if (!h[e]) throw "complete called for nonexistent message: " + e;
                                delete h[e];
                                b({
                                    id: e,
                                    result: t
                                })
                            },
                            delayReturn: function (e) {
                                if (typeof e === "boolean") {
                                    r = e === true
                                }
                                return r
                            },
                            completed: function () {
                                return i
                            }
                        }
                    };
                    var m = function (e, t, n) {
                        return window.setTimeout(function () {
                            if (c[e]) {
                                var r = "timeout (" + t + "ms) exceeded on method '" + n + "'";
                                (1, c[e].error)("timeout_error", r);
                                delete c[e];
                                delete s[e]
                            }
                        }, t)
                    };
                    var g = function (e, n, r) {
                        if (typeof t.gotMessageObserver === "function") {
                            try {
                                t.gotMessageObserver(e, r)
                            } catch (u) {
                                o("gotMessageObserver() raised an exception: " + u.toString())
                            }
                        }
                        if (r.id && n) {
                            if (l[n]) {
                                var a = v(r.id, e, r.callbacks ? r.callbacks : []);
                                h[r.id] = {};
                                try {
                                    if (r.callbacks && i(r.callbacks) && r.callbacks.length > 0) {
                                        for (var f = 0; f < r.callbacks.length; f++) {
                                            var p = r.callbacks[f];
                                            var d = r.params;
                                            var m = p.split("/");
                                            for (var g = 0; g < m.length - 1; g++) {
                                                var y = m[g];
                                                if (typeof d[y] !== "object") d[y] = {};
                                                d = d[y]
                                            }
                                            d[m[m.length - 1]] = function () {
                                                var e = p;
                                                return function (t) {
                                                    return a.invoke(e, t)
                                                }
                                            }()
                                        }
                                    }
                                    var b = l[n](a, r.params);
                                    if (!a.delayReturn() && !a.completed()) a.complete(b)
                                } catch (u) {
                                    var w = "runtime_error";
                                    var E = null;
                                    if (typeof u === "string") {
                                        E = u
                                    } else if (typeof u === "object") {
                                        if (u && i(u) && u.length == 2) {
                                            w = u[0];
                                            E = u[1]
                                        } else if (typeof u.error === "string") {
                                            w = u.error;
                                            if (!u.message) E = "";
                                            else if (typeof u.message === "string") E = u.message;
                                            else u = u.message
                                        }
                                    }
                                    if (E === null) {
                                        try {
                                            E = JSON.stringify(u);
                                            if (typeof E == "undefined") E = u.toString()
                                        } catch (S) {
                                            E = u.toString()
                                        }
                                    }
                                    a.error(w, E)
                                }
                            }
                        } else if (r.id && r.callback) {
                            if (!c[r.id] || !c[r.id].callbacks || !c[r.id].callbacks[r.callback]) {
                                o("ignoring invalid callback, id:" + r.id + " (" + r.callback + ")")
                            } else {
                                c[r.id].callbacks[r.callback](r.params)
                            }
                        } else if (r.id) {
                            if (!c[r.id]) {
                                o("ignoring invalid response: " + r.id)
                            } else {
                                if (r.error) {
                                    (1, c[r.id].error)(r.error, r.message)
                                } else {
                                    if (r.result !== undefined)(1, c[r.id].success)(r.result);
                                    else(1, c[r.id].success)()
                                }
                                delete c[r.id];
                                delete s[r.id]
                            }
                        } else if (n) {
                            if (l[n]) {
                                l[n]({
                                    origin: e
                                }, r.params)
                            }
                        }
                    };
                    n(t.window, t.origin, typeof t.scope === "string" ? t.scope : "", g);
                    var y = function (e) {
                        if (typeof t.scope === "string" && t.scope.length) e = [t.scope, e].join("::");
                        return e
                    };
                    var b = function (e, n) {
                        if (!e) throw "postMessage called with null message";
                        var r = p ? "post  " : "queue ";
                        o(r + " message: " + JSON.stringify(e));
                        if (!n && !p) {
                            d.push(e)
                        } else {
                            if (typeof t.postMessageObserver === "function") {
                                try {
                                    t.postMessageObserver(t.origin, e)
                                } catch (i) {
                                    o("postMessageObserver() raised an exception: " + i.toString())
                                }
                            }
                            t.window.postMessage(JSON.stringify(e), t.origin)
                        }
                    };
                    var w = function (e, n) {
                        o("ready msg received");
                        if (p) throw "received ready message while in ready state.  help!";
                        if (n === "ping") {
                            f += "-R"
                        } else {
                            f += "-L"
                        }
                        E.unbind("__ready");
                        p = true;
                        o("ready msg accepted.");
                        if (n === "ping") {
                            E.notify({
                                method: "__ready",
                                params: "pong"
                            })
                        }
                        while (d.length) {
                            b(d.pop())
                        }
                        if (typeof t.onReady === "function") t.onReady(E)
                    };
                    var E = {
                        unbind: function (e) {
                            if (l[e]) {
                                if (!delete l[e]) throw "can't delete method: " + e;
                                return true
                            }
                            return false
                        },
                        bind: function (e, t) {
                            if (!e || typeof e !== "string") throw "'method' argument to bind must be string";
                            if (!t || typeof t !== "function") throw "callback missing from bind params";
                            if (l[e]) throw "method '" + e + "' is already bound!";
                            l[e] = t;
                            return this
                        },
                        call: function (t) {
                            if (!t) throw "missing arguments to call function";
                            if (!t.method || typeof t.method !== "string") throw "'method' argument to call must be string";
                            if (!t.success || typeof t.success !== "function") throw "'success' callback missing from call";
                            var n = {};
                            var r = [];
                            var i = [];
                            var o = function (e, t) {
                                if (i.indexOf(t) >= 0) {
                                    throw "params cannot be a recursive data structure"
                                }
                                i.push(t);
                                if (typeof t === "object") {
                                    for (var s in t) {
                                        if (!t.hasOwnProperty(s)) continue;
                                        var u = e + (e.length ? "/" : "") + s;
                                        if (typeof t[s] === "function") {
                                            n[u] = t[s];
                                            r.push(u);
                                            delete t[s]
                                        } else if (typeof t[s] === "object") {
                                            o(u, t[s])
                                        }
                                    }
                                }
                            };
                            o("", t.params);
                            var u = {
                                id: e,
                                method: y(t.method),
                                params: t.params
                            };
                            if (r.length) u.callbacks = r;
                            if (t.timeout) m(e, t.timeout, y(t.method));
                            c[e] = {
                                callbacks: n,
                                error: t.error,
                                success: t.success
                            };
                            s[e] = g;
                            e++;
                            b(u)
                        },
                        notify: function (e) {
                            if (!e) throw "missing arguments to notify function";
                            if (!e.method || typeof e.method !== "string") throw "'method' argument to notify must be string";
                            b({
                                method: y(e.method),
                                params: e.params
                            })
                        },
                        destroy: function () {
                            r(t.window, t.origin, typeof t.scope === "string" ? t.scope : "");
                            if (window.removeEventListener) window.removeEventListener("message", g, false);
                            else if (window.detachEvent) window.detachEvent("onmessage", g);
                            p = false;
                            l = {};
                            h = {};
                            c = {};
                            t.origin = null;
                            d = [];
                            o("channel destroyed");
                            f = ""
                        }
                    };
                    E.bind("__ready", w);
                    setTimeout(function () {
                        b({
                            method: y("__ready"),
                            params: "ping"
                        }, true)
                    }, 0);
                    return E
                }
            }
        }()
    </script>
    <style>
        button {
            -webkit-background-clip: padding-box;
            -webkit-box-shadow: rgb(255, 255, 255) 0px 1px 0px 0px inset;
            -webkit-font-smoothing: antialiased;
            background-clip: padding-box;
            background-color: rgb(238, 238, 238);
            background-image: linear-gradient(rgb(238, 238, 238), rgb(210, 210, 210));
			border: 1px solid rgb(202,202,202);
            border-bottom-left-radius: 3px;
            border-bottom-right-radius: 3px;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
            box-shadow: inset 0 0 1px rgb(255, 255, 255);
            color: rgb(51, 51, 51);
            cursor: pointer;
            display: inline-block;
            font-family: 'Open Sans', Verdana, Geneva, sans-serif, sans-serif;
            font-size: 13px;
            font-weight: 400;
            height: 40px;
            letter-spacing: normal;
            line-height: normal;
            margin: 0 0 0 0;
            padding: 7px 18px;
            text-align: center;
            text-shadow: rgb(248, 248, 248) 0px 1px 0px;
            vertical-align: middle;
        }
        button:hover {
            -webkit-box-shadow: rgb(251, 251, 251) 0px 1px 0px 0px inset;
            background-color: rgb(225, 225, 225);
            background-image: linear-gradient(rgb(225, 225, 225), rgb(202, 202, 202));
            box-shadow: rgb(251, 251, 251) 0px 1px 0px 0px inset;
            color: rgb(51, 51, 51);
        }
        button:active {
            -webkit-box-shadow: rgb(195, 195, 195) 0px 0px 8px 4px inset, rgb(195, 195, 195) 0px 0px 8px 4px inset, rgb(238, 238, 238) 0px 1px 1px 0px;
            box-shadow: rgb(195, 195, 195) 0px 0px 8px 4px inset, rgb(195, 195, 195) 0px 0px 8px 4px inset, rgb(238, 238, 238) 0px 0px 1px 0px;
        }
        .text_box {
            overflow: auto;
            display: none;
            background-color: rgb(250, 248, 239);
            margin-bottom: -16px;
            font-size: .5em;
            color: rgb(100, 100, 100);
            font-family: 'Open Sans', Verdana, Geneva, sans-serif, sans-serif;
        }
        .text_box_contents {
            margin-left: 20px;
            margin-right: 20px;
            padding-top: 5px;
            padding-bottom: 5px;
        }
        #drag {
            background-color: #fff;
        }
    </style>
</head>

<body>
    <div class="drag_drop" />
    <script>
        var JSInput = (function () {
			
			// Setting up variables
            this.state = {},this.inp = {},this.bool = false,window.h;
			var c=this,channel;

			// Get query string variables
	        function $_GET(sVar) {
	            return decodeURI(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + encodeURI(sVar).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
	        }

			// Update everything
            function drag_update(resetting) {
                var s = {},i,d;
                for (i = 0; i < c.inp.draggables.length; i++) {
					d=c.inp.draggables[i],$q=$('#'+d.id);
					
					// Reset to start location if close or resetting
                    (isNearStart(i) || resetting)&&$q.position({
                    	my: 'center',
                    	at: "left+" + String(d.pos.x) + " top+" + String(d.pos.y),
                    	of: $('#drop')
                    })&&c.inp.hoverZoom&&window.h==d.id&&$q.position({
                    	my: "left+" + String(d.size.width*.1) + " top+" + String(d.size.height*.1),
						at: 'left top',
						of: $q
                    });
					
					// Add draggable to state
                    s[d.id] = [$q.offset().left + $q.width() / 2 - $('#drop').offset().left, $q.offset().top + $q.height() / 2 - $('#drop').offset().top];
                }
                c.state = s;
            }

			// Resets all contents
            function reset() {
                var html = '',s = {},d,i,dE,
					dropE=document.getElementById("drop"),
					frag=document.createDocumentFragment();
				// Add each draggable to a fragment and store location for returned state
                for (i = 0; i < c.inp.draggables.length; i++) {
                    d = c.inp.draggables[i], 
					dE=document.createElement("div"),
					dE.id=d.id,
					dE.className="draggable",
					dE.style.backgroundImage='url('+d.url+')',
					dE.style.backgroundSize=String(d.size.width)+'px '+String(d.size.height)+'px',
					dE.style.position="relative",
					dE.style.width=String(d.size.width)+'px',
					dE.style.height=String(d.size.height)+'px',
					dE.onmouseout=drag_update,
					s[d.id] = [d.pos.x + d.size.width / 2, d.pos.y + d.size.height / 2],
					frag.appendChild(dE);
                }
				// update DOM
				document.getElementById('drop').innerText='';
                document.getElementById('drop').appendChild(frag);
				// Make draggables actually draggable
                for (i = 0; i < c.inp.draggables.length; i++) {
                    $q = $('#' + c.inp.draggables[i].id);
                    $q.draggable({
                        containment: 'parent'
                    });
                    $q.css("cursor", ((typeof (c.inp.cursor) == 'undefined') ? 'move' : c.inp.cursor));
                }
				// Reposition new draggables for consistency
                drag_update(true);
				// Return State
                return s;
            }

            function init(input) {
				// Store JSON data
                c.inp = input;
				var dropE = document.createElement("div"),
					resetE = document.createElement("button"),
					helpE = document.createElement("button"),
					textE = document.createElement("div"),
					textContentE = document.createElement("div"),
					styleE = document.createElement("style"),
					dragdrop = document.createDocumentFragment(),
                	static_style = '',
					hover_style = (typeof (c.inp.hoverZoom) !== 'undefined' && c.inp.hoverZoom) ? '-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1);' : '',
					i;
					
				// Add drop image div
				dropE.id="drop",
				dropE.style.backgroundImage="url("+c.inp.drop_image+")",
				dropE.style.backgroundSize=c.inp.size.width+'px '+c.inp.size.height+'px',
				dropE.style.width=c.inp.size.width+'px',
				dropE.style.height=c.inp.size.height + 'px';
				dragdrop.appendChild(dropE);
				
				// Add help and reset buttons
				resetE.className="resetButton",
				resetE.innerHTML="Reset",
				helpE.className="helpButton",
				helpE.innerHTML="Help",
				textE.className="text_box",
				textContentE.className="text_box_contents",
				textContentE.appendChild(document.createTextNode(((typeof (c.inp.hoverZoom) !== 'undefined' && c.inp.hoverZoom) ? 'Items that are draggable will expand when your mouse hovers over them.\n' : '') +
					'Move draggable items to their correct targets.\n'+
					'If no correct target exists for an item, move the item back to its original location and it will snap into place. Alternatively, you can use the "Reset" button to reset all draggables.\n'+
					'Click "Help" to dismiss.'));
				textE.appendChild(textContentE);
				dragdrop.appendChild(resetE);
				dragdrop.appendChild(helpE);
				dragdrop.appendChild(textE);
				
				// Iterate over specified CSS if applicable
                if (typeof (c.inp.css) !== 'undefined') {
                    for (i = 0; i < c.inp.css.length; i++) {
                        static_style = static_style + c.inp.css[i][0] + ':' + c.inp.css[i][1] + ';';
                    }
                }
                if (typeof (inp.hover) !== 'undefined') {
                    for (i = 0; i < c.inp.hover.length; i++) {
                        hover_style = hover_style + c.inp.hover[i][0] + ':' + c.inp.hover[i][1] + ';';
                    }
                }
				// Push new styles
				styleE.appendChild(document.createTextNode('.draggable{outline: 1px solid transparent;' + static_style + '}.draggable:hover{' + hover_style + '}'));
				dragdrop.appendChild(styleE);
				// Update DOM
				document.getElementsByClassName('drag_drop')[0].appendChild(dragdrop);
                c.state = reset();
            }
			
			// Return boolean if near start
            function isNearStart(i) {
                var d = c.inp.draggables[i];
                return (Math.abs($('#' + d.id).position().left - $('#drop').position().left + $('#' + d.id).width() / 2 - d.pos.x) < $('#' + d.id).width() && Math.abs($('#' + d.id).position().top - $('#drop').position().top + $('#' + d.id).height() / 2 - d.pos.y) < $('#' + d.id).height());
            }
			
			// Get JSON, initialize everything
	        $.ajax({
	            dataType: "text",
	            url: String($_GET('js')) + ".json",
	            async: false,
	            success: function(data){
					init(JSON.parse(data));
	           		$(document).mouseup(function () {drag_update(false);});
               		$('.resetButton').click(reset);
               		$('.text_box').width($('#drop').width() - 150);
               		$('.text_box').height($('button').css('height'));
               		$('.text_box').html();
               		$('.helpButton').click(function () {
			   			$('.text_box').css('display', c.bool?'none':'inline-block');
			   			c.bool=!c.bool;
               		});
				}
	        });

			// For jsinput grading, bind functions to channel
            if (window.parent !== window) {
                channel = Channel.build({
                    window: window.parent,
                    origin: "*",
                    scope: "JSInput"
                });
                channel.bind("getGrade", getGrade);
                channel.bind("getState", getState);
                channel.bind("setState", setState);
            }

            function getState() {
                return JSON.stringify(c.state);
            }

            function getGrade() {
                return JSON.stringify(c.inp);
            }

            function setState() {
				// Update stored state
                c.state = JSON.parse(arguments.length === 1 ? arguments[0] : arguments[1]);
				// Iterate over draggables and reposition according to state
                for (var i = 0; i < c.inp.draggables.length; i++) {
                    $q = $('#' + c.inp.draggables[i].id);
                    $q.position({
                        my: 'center',
                        at: "left+" + String(c.state[c.inp.draggables[i].id][0]) + " top+" + String(c.state[c.inp.draggables[i].id][1]),
                        of: $('#drop')
                    });
                }
            }
            return {
                getState: getState,
                setState: setState,
                getGrade: getGrade
            };
        }());
		
		// Safari zoom issue - alert when problems may occur
        if (navigator.vendor == "Apple Computer, Inc.") {
            var zoom = document.documentElement.clientWidth / window.innerWidth;
            $(window).resize(function () {
                if (zoom != document.documentElement.clientWidth / window.innerWidth) {
                    alert("Zooming with Safari will cause issues with this Drag and Drop problem. Please use native operating system zoom or use a different browser.");
                }
            });
        }
    </script>
</body>